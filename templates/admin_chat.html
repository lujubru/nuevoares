{% extends "base.html" %}
{% block title %}Chat Admin{% endblock %}
{% block head %}
    {{ super() }}
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
{% endblock %}
{% block sidebar %}
<div id="sidebar-chats" class="bg-black text-white w-full sm:w-64 p-3 sm:p-4 overflow-y-auto">
    <h3 class="text-base sm:text-lg font-semibold mb-4 text-yellow-500">Chats Abiertos</h3>
    {% for chat in chats %}
        <a href="{{ url_for('admin_chat', chat_id=chat[0]) }}" class="block p-2 sm:p-3 rounded-lg mb-2 {% if chat[4] %}bg-red-600{% else %}bg-gray-800{% endif %} {% if chat_id is defined and chat[0] == chat_id %}bg-yellow-600{% endif %} hover:bg-gray-700 transition">
            <span class="text-xs sm:text-sm">{{ chat[1] }} {{ chat[2] }} ({{ chat[3] }})</span>
            {% if chat[4] %}<span class="text-xs bg-red-400 text-black px-1 rounded ml-2">No leído</span>{% endif %}
        </a>
    {% endfor %}
</div>
{% endblock %}
{% block content %}
<div class="flex flex-col flex-1 h-[calc(100vh-8rem)] sm:h-[calc(100vh-4rem)]">
    <div class="bg-gray-900 text-white p-3 sm:p-4 flex items-center justify-between shadow-lg">
        <h2 class="text-base sm:text-lg font-semibold">{{ user[0] }} {{ user[1] }} ({{ user[2] }})</h2>
        <div class="flex space-x-2 sm:space-x-4">
            <a href="{{ url_for('admin_dashboard') }}" class="text-xs sm:text-sm text-yellow-500 hover:text-yellow-400 transition">Volver</a>
            {% if chat_id is defined %}
                <a href="{{ url_for('close_chat', chat_id=chat_id) }}" class="text-xs sm:text-sm text-red-400 hover:text-red-300 transition">Cerrar Chat</a>
            {% endif %}
        </div>
    </div>
    <div id="chat-container" class="flex-1 p-3 sm:p-4 overflow-y-auto flex flex-col space-y-2 bg-gray-800">
        {% for message in messages %}
            <div class="flex mb-2 {% if message[5] %}justify-start{% else %}justify-end{% endif %}">
                <div class="max-w-[70%] sm:max-w-xs p-2 sm:p-3 rounded-lg shadow-md relative {% if message[5] %}bg-blue-900 text-white{% else %}bg-yellow-600 text-black{% endif %}">
                    <p class="text-xs sm:text-sm">{{ message[0] }}</p>
                    {% if message[4] %}
                        <a href="{{ url_for('static', filename=message[4] | replace('static/', '')) }}" target="_blank" class="text-red-400 text-xs underline">Ver archivo</a>
                    {% endif %}
                    <p class="text-xs text-gray-300 mt-1">{{ message[1].strftime('%H:%M') }}</p>
                    <div class="absolute bottom-0 {% if message[5] %}left-[-6px] sm:left-[-8px] border-r-6 sm:border-r-8 border-r-blue-900{% else %}right-[-6px] sm:right-[-8px] border-l-6 sm:border-l-8 border-l-yellow-600{% endif %} border-b-6 sm:border-b-8 border-b-transparent w-0 h-0"></div>
                </div>
            </div>
        {% endfor %}
    </div>
    <div class="bg-gray-800 p-3 sm:p-4 border-t border-gray-700 fixed sm:static bottom-0 left-0 right-0 z-10">
        <form id="message-form" enctype="multipart/form-data" class="flex items-center space-x-2">
            <div class="flex-1 bg-gray-900 rounded-lg shadow-sm flex items-center px-2 sm:px-3 border border-yellow-500">
                <input type="text" id="message" class="flex-1 p-2 text-xs sm:text-sm bg-transparent text-white outline-none" placeholder="Escribe un mensaje...">
                <label for="file" class="text-yellow-500 cursor-pointer">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 002.828 2.828l6.586-6.586a4 4 0 00-5.656-5.656L5.586 10.758a6 6 0 008.486 8.486L20.658 12.17"></path></svg>
                </label>
                <input type="file" id="file" class="hidden">
            </div>
            <button type="submit" class="bg-red-500 text-white rounded-full p-2 sm:p-2 hover:bg-red-600 transition">
                <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
            </button>
        </form>
    </div>
</div>
<script>
    const chatContainer = document.getElementById('chat-container');
    let lastMessageTimestamp = '';

    // Función para hacer scroll hacia abajo
    function scrollToBottom() {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Scroll inicial al cargar la página
    window.addEventListener('load', function() {
        setTimeout(scrollToBottom, 100);
    });

    // Función para añadir un mensaje al chat
    function addMessage(data) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex mb-2 ' + (data.is_user ? 'justify-start' : 'justify-end');
        messageDiv.innerHTML = `
            <div class="max-w-[70%] sm:max-w-xs p-2 sm:p-3 rounded-lg shadow-md relative ${data.is_user ? 'bg-blue-900 text-white' : 'bg-yellow-600 text-black'}">
                <p class="text-xs sm:text-sm">${data.content}</p>
                ${data.file_path ? `<a href="/static/${data.file_path.replace('static/', '')}" target="_blank" class="text-red-400 text-xs underline">Ver archivo</a>` : ''}
                <p class="text-xs text-gray-300 mt-1">${data.timestamp.split(' ')[1].slice(0, 5)}</p>
                <div class="absolute bottom-0 ${data.is_user ? 'left-[-6px] sm:left-[-8px] border-r-6 sm:border-r-8 border-r-blue-900' : 'right-[-6px] sm:right-[-8px] border-l-6 sm:border-l-8 border-l-yellow-600'} border-b-6 sm:border-b-8 border-b-transparent w-0 h-0"></div>
            </div>
        `;
        chatContainer.appendChild(messageDiv);
        setTimeout(scrollToBottom, 50);
    }

    // Polling para obtener nuevos mensajes
    function pollMessages() {
        fetch('/get_messages/{{ chat_id }}')
            .then(response => response.json())
            .then(messages => {
                messages.reverse().forEach(msg => {
                    if (msg.timestamp > lastMessageTimestamp) {
                        addMessage(msg);
                        lastMessageTimestamp = msg.timestamp;
                    }
                });
            })
            .catch(error => {
                console.error('Error polling messages:', error);
            });
    }

    // Polling para actualizar la barra lateral
    function pollSidebar() {
        fetch('/admin/get_chats')
            .then(response => response.text())
            .then(html => {
                document.getElementById('sidebar-chats').innerHTML = html;
            })
            .catch(error => {
                console.error('Error polling sidebar:', error);
            });
    }

    // Iniciar polling cada 5 segundos
    setInterval(pollMessages, 5000);
    setInterval(pollSidebar, 5000);
    pollMessages(); // Llamada inicial
    pollSidebar(); // Llamada inicial

    document.getElementById('message-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const messageInput = document.getElementById('message');
        const fileInput = document.getElementById('file');
        const message = messageInput.value;
        if (!message && !fileInput.files[0]) return;
        
        // Limpiar los campos inmediatamente después del envío
        messageInput.value = '';
        fileInput.value = '';
        
        const formData = new FormData();
        formData.append('chat_id', {{ chat_id }});
        formData.append('sender_id', {{ session['admin_id'] }});
        formData.append('content', message);
        formData.append('is_admin', 'true');
        if (fileInput.files[0]) {
            formData.append('file', fileInput.files[0]);
        }
        
        fetch('/send_message', {
            method: 'POST',
            body: formData
        }).then(response => response.json())
          .then(data => {
              if (data.status === 'success') {
                  console.log('Message sent successfully');
              } else {
                  console.error('Error sending message:', data);
                  alert('Error al enviar el mensaje. Intenta de nuevo.');
                  messageInput.value = message;
              }
          }).catch(error => {
              console.error('Fetch error:', error);
              alert('Error de conexión. Verifica tu red e intenta de nuevo.');
              messageInput.value = message;
          });
    });
</script>
{% endblock %}