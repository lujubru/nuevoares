{% extends "base.html" %}
{% block title %}Chat Admin{% endblock %}
{% block head %}
    {{ super() }}
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
{% endblock %}
{% block sidebar %}
<div id="sidebar-chats" class="bg-black text-white w-full sm:w-64 p-3 sm:p-4 overflow-y-auto">
    <h3 class="text-base sm:text-lg font-semibold mb-4 text-yellow-500">Chats Abiertos</h3>
    {% for chat in chats %}
        <a href="{{ url_for('admin_chat', chat_id=chat[0]) }}" class="block p-2 sm:p-3 rounded-lg mb-2 {% if chat[4] %}bg-red-600{% else %}bg-gray-800{% endif %} {% if chat_id is defined and chat[0] == chat_id %}bg-yellow-600{% endif %} hover:bg-gray-700 transition">
            <span class="text-xs sm:text-sm">{{ chat[1] }} {{ chat[2] }} ({{ chat[3] }})</span>
            {% if chat[4] %}<span class="text-xs bg-red-400 text-black px-1 rounded ml-2">No leído</span>{% endif %}
        </a>
    {% endfor %}
</div>
{% endblock %}
{% block content %}
<div class="flex flex-col flex-1 h-[calc(100vh-8rem)] sm:h-[calc(100vh-4rem)]">
    <div class="bg-gray-900 text-white p-3 sm:p-4 flex items-center justify-between shadow-lg">
        <h2 class="text-base sm:text-lg font-semibold">{{ user[0] }} {{ user[1] }} ({{ user[2] }})</h2>
        <div class="flex space-x-2 sm:space-x-4">
            <a href="{{ url_for('admin_dashboard') }}" class="text-xs sm:text-sm text-yellow-500 hover:text-yellow-400 transition">Volver</a>
            {% if chat_id is defined %}
                <a href="{{ url_for('close_chat', chat_id=chat_id) }}" class="text-xs sm:text-sm text-red-400 hover:text-red-300 transition">Cerrar Chat</a>
            {% endif %}
        </div>
    </div>
    <div id="chat-container" class="flex-1 p-3 sm:p-4 overflow-y-auto flex flex-col space-y-2 bg-gray-800">
        {% for message in messages %}
            <div class="flex mb-2 {% if message[5] %}justify-start{% else %}justify-end{% endif %}">
                <div class="max-w-[70%] sm:max-w-xs p-2 sm:p-3 rounded-lg shadow-md relative {% if message[5] %}bg-blue-900 text-white{% else %}bg-yellow-600 text-black{% endif %}">
                    <p class="text-xs sm:text-sm">{{ message[0] }}</p>
                    {% if message[4] %}
                        <a href="{{ url_for('static', filename=message[4] | replace('static/', '')) }}" target="_blank" class="text-red-400 text-xs underline">Ver archivo</a>
                    {% endif %}
                    <p class="text-xs text-gray-300 mt-1">{{ message[1].strftime('%H:%M') }}</p>
                    <div class="absolute bottom-0 {% if message[5] %}left-[-6px] sm:left-[-8px] border-r-6 sm:border-r-8 border-r-blue-900{% else %}right-[-6px] sm:right-[-8px] border-l-6 sm:border-l-8 border-l-yellow-600{% endif %} border-b-6 sm:border-b-8 border-b-transparent w-0 h-0"></div>
                </div>
            </div>
        {% endfor %}
    </div>
    <div class="bg-gray-800 p-3 sm:p-4 border-t border-gray-700 fixed sm:static bottom-0 left-0 right-0 z-10">
        <form id="message-form" enctype="multipart/form-data" class="flex items-center space-x-2">
            <div class="flex-1 bg-gray-900 rounded-lg shadow-sm flex items-center px-2 sm:px-3 border border-yellow-500">
                <input type="text" id="message" class="flex-1 p-2 text-xs sm:text-sm bg-transparent text-white outline-none" placeholder="Escribe un mensaje...">
                <label for="file" class="text-yellow-500 cursor-pointer">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 002.828 2.828l6.586-6.586a4 4 0 00-5.656-5.656L5.586 10.758a6 6 0 008.486 8.486L20.658 12.17"></path></svg>
                </label>
                <input type="file" id="file" class="hidden">
            </div>
            <button type="submit" class="bg-red-500 text-white rounded-full p-2 sm:p-2 hover:bg-red-600 transition" id="send-btn">
                <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
            </button>
        </form>
    </div>
</div>
<script>
    // Variables globales
    let socket;
    let isConnected = false;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 10;
    const chatContainer = document.getElementById('chat-container');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message');
    const fileInput = document.getElementById('file');
    const sendBtn = document.getElementById('send-btn');
    
    // Función para hacer scroll hacia abajo
    function scrollToBottom() {
        if (chatContainer) {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    }
    
    // Función para inicializar SocketIO
    function initializeSocket() {
        socket = io({
            reconnection: true,
            reconnectionAttempts: maxReconnectAttempts,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            maxReconnectionAttempts: maxReconnectAttempts,
            timeout: 20000,
            forceNew: true,
            transports: ['websocket', 'polling']
        });
        
        socket.on('connect', function() {
            console.log('Connected to SocketIO');
            isConnected = true;
            reconnectAttempts = 0;
            
            {% if chat_id is defined %}
                socket.emit('join', { chat_id: {{ chat_id }} });
            {% endif %}
        });
        
        socket.on('disconnect', function(reason) {
            console.log('Disconnected from SocketIO:', reason);
            isConnected = false;
        });
        
        socket.on('connect_error', function(error) {
            console.log('Connection error:', error);
            isConnected = false;
        });
        
        socket.on('join_success', function(data) {
            console.log('Successfully joined room:', data.room);
        });
        
        socket.on('join_error', function(data) {
            console.log('Error joining room:', data.error);
        });
        
        {% if chat_id is defined %}
            socket.on('new_message', function(data) {
                console.log('New message received:', data);
                
                // Verificar que el mensaje es para este chat
                if (data.chat_id && data.chat_id != {{ chat_id }}) {
                    return;
                }
                
                const messageDiv = document.createElement('div');
                // data.is_user: true = usuario regular, false = admin
                // Para el admin: mostrar mensajes de usuario a la izquierda, propios a la derecha
                const isFromUser = data.is_user === true;
                messageDiv.className = 'flex mb-2 ' + (isFromUser ? 'justify-start' : 'justify-end');
                
                const bgClass = isFromUser ? 'bg-blue-900 text-white' : 'bg-yellow-600 text-black';
                const arrowClass = isFromUser ? 
                    'left-[-6px] sm:left-[-8px] border-r-6 sm:border-r-8 border-r-blue-900' : 
                    'right-[-6px] sm:right-[-8px] border-l-6 sm:border-l-8 border-l-yellow-600';
                
                messageDiv.innerHTML = `
                    <div class="max-w-[70%] sm:max-w-xs p-2 sm:p-3 rounded-lg shadow-md relative ${bgClass}">
                        <p class="text-xs sm:text-sm">${escapeHtml(data.content)}</p>
                        ${data.file_path ? `<a href="/static/${data.file_path.replace('static/', '')}" target="_blank" class="text-red-400 text-xs underline">Ver archivo</a>` : ''}
                        <p class="text-xs text-gray-300 mt-1">${formatTime(data.timestamp)}</p>
                        <div class="absolute bottom-0 ${arrowClass} border-b-6 sm:border-b-8 border-b-transparent w-0 h-0"></div>
                    </div>
                `;
                
                chatContainer.appendChild(messageDiv);
                setTimeout(scrollToBottom, 50);
            });
        {% endif %}
        
        // Escuchar eventos de nuevos chats o actualizaciones
        socket.on('new_chat', function(data) {
            updateSidebar();
        });
        
        // Escuchar eventos de chats cerrados
        socket.on('chat_closed', function(data) {
            if (data.chat_id == {{ chat_id if chat_id is defined else 'null' }}) {
                window.location.href = '{{ url_for('admin_dashboard') }}';
            } else {
                updateSidebar();
            }
        });
    }
    
    // Función para escapar HTML
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }
    
    // Función para formatear tiempo
    function formatTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
    }
    
    // Función para actualizar la barra lateral
    function updateSidebar() {
        fetch('/admin/get_chats')
            .then(response => response.text())
            .then(html => {
                const sidebarElement = document.getElementById('sidebar-chats');
                if (sidebarElement) {
                    sidebarElement.innerHTML = html;
                }
            })
            .catch(error => {
                console.error('Error updating sidebar:', error);
            });
    }
    
    // Función para enviar mensaje
    function sendMessage(event) {
        event.preventDefault();
        
        const message = messageInput.value.trim();
        const file = fileInput.files[0];
        
        if (!message && !file) {
            return;
        }
        
        // Deshabilitar el formulario mientras se envía
        sendBtn.disabled = true;
        messageInput.disabled = true;
        
        const formData = new FormData();
        formData.append('chat_id', {{ chat_id if chat_id is defined else '0' }});
        formData.append('sender_id', {{ session['admin_id'] if session.get('admin_id') else '0' }});
        formData.append('content', message);
        formData.append('is_admin', 'true');
        if (file) {
            formData.append('file', file);
        }
        
        fetch('/send_message', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log('Message sent successfully');
                // Limpiar el formulario solo después del éxito
                messageInput.value = '';
                fileInput.value = '';
            } else {
                console.error('Error sending message:', data);
                alert('Error al enviar el mensaje: ' + (data.message || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            alert('Error de conexión. Verifica tu red e intenta de nuevo.');
        })
        .finally(() => {
            // Rehabilitar el formulario
            sendBtn.disabled = false;
            messageInput.disabled = false;
            messageInput.focus();
        });
    }
    
    // Inicialización cuando se carga la página
    window.addEventListener('load', function() {
        setTimeout(scrollTo
